{% extends "base.html" %}

{% block title %}Create Trade Plan - {{ app_name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('trade.list') }}">Trades</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('trade.view', trade_id=trade.id) }}">{{ trade.symbol }}</a></li>
            <li class="breadcrumb-item active">Create Plan</li>
        </ol>
    </nav>
    <h1 class="page-title">
        <i class="fas fa-clipboard-list"></i> Pre-Trade Planning
    </h1>
    <p class="page-subtitle">Plan your trade BEFORE you take it. This builds discipline!</p>
</div>

<!-- Trade Summary -->
<div class="alert alert-info mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong><i class="fas fa-chart-line"></i> {{ trade.symbol }}</strong>
            <span class="badge {% if trade.trade_type == 'BUY' %}bg-success{% else %}bg-danger{% endif %} ms-2">
                {{ trade.trade_type }}
            </span>
        </div>
        <div>
            <strong>Entry:</strong> {{ trade.entry_price }}
            {% if trade.stop_loss %} | <strong>SL:</strong> {{ trade.stop_loss }}{% endif %}
            {% if trade.take_profit %} | <strong>TP:</strong> {{ trade.take_profit }}{% endif %}
        </div>
    </div>
</div>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Market Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-search-dollar"></i> Market Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            {{ form.market_bias.label(class="form-label fw-bold") }}
                            {{ form.market_bias(class="form-select") }}
                            {% for error in form.market_bias.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form.setup_type.label(class="form-label fw-bold") }}
                            {{ form.setup_type(class="form-select") }}
                            {% for error in form.setup_type.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-4">
                            {{ form.confluence_score.label(class="form-label fw-bold") }}
                            {{ form.confluence_score(class="form-control", placeholder="0-10") }}
                            <small class="text-muted">How many confluences?</small>
                            {% for error in form.confluence_score.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Planned Levels -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-crosshairs"></i> Planned Entry & Levels</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            {{ form.planned_entry.label(class="form-label fw-bold") }}
                            {{ form.planned_entry(class="form-control", placeholder="1.20000", id="planned_entry") }}
                            {% for error in form.planned_entry.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            {{ form.planned_stop_loss.label(class="form-label fw-bold") }}
                            {{ form.planned_stop_loss(class="form-control", placeholder="1.19500", id="planned_sl") }}
                            {% for error in form.planned_stop_loss.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            {{ form.planned_take_profit.label(class="form-label fw-bold") }}
                            {{ form.planned_take_profit(class="form-control", placeholder="1.21000", id="planned_tp") }}
                            {% for error in form.planned_take_profit.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            {{ form.planned_risk_percentage.label(class="form-label fw-bold") }}
                            {{ form.planned_risk_percentage(class="form-control", placeholder="1.0") }}
                            <small class="text-muted">Max recommended: 2%</small>
                            {% for error in form.planned_risk_percentage.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- R:R Calculator -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <small class="text-muted d-block">Planned R:R</small>
                                <strong id="planned_rr" class="h4 text-primary">—</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Risk (distance)</small>
                                <strong id="risk_dist" class="h5">—</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Reward (distance)</small>
                                <strong id="reward_dist" class="h5">—</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Psychology -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-brain"></i> Psychology Check</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.emotion_before.label(class="form-label fw-bold") }}
                            {{ form.emotion_before(class="form-select") }}
                            {% for error in form.emotion_before.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.emotion_intensity_before.label(class="form-label fw-bold") }}
                            {{ form.emotion_intensity_before(class="form-control", placeholder="1-10") }}
                            {% for error in form.emotion_intensity_before.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Emotional Warning -->
                    <div id="emotion_warning" class="alert alert-warning mt-3 d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Trading with this emotion may lead to poor decisions. Consider waiting.
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Trade Plan Notes</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {{ form.pre_trade_notes.label(class="form-label fw-bold") }}
                        {{ form.pre_trade_notes(class="form-control", rows="4", placeholder="Why are you taking this trade? What's your thesis?") }}
                        {% for error in form.pre_trade_notes.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.key_levels.label(class="form-label fw-bold") }}
                        {{ form.key_levels(class="form-control", rows="2", placeholder="List important S/R levels, zones, etc.") }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.trade_hypothesis.label(class="form-label fw-bold") }}
                        {{ form.trade_hypothesis(class="form-control", rows="2", placeholder="If X happens, then Y should follow...") }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Screenshot Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-camera"></i> Chart Screenshot (Before)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {{ form.screenshot_before(class="form-control") }}
                        <small class="text-muted">Upload your chart analysis screenshot</small>
                    </div>
                    
                    <div id="preview_container" class="d-none">
                        <img id="screenshot_preview" class="img-fluid rounded" alt="Preview">
                    </div>
                </div>
            </div>
            
            <!-- Checklist -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Pre-Trade Checklist</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="check1">
                        <label class="form-check-label" for="check1">Identified clear setup?</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="check2">
                        <label class="form-check-label" for="check2">Stop loss defined?</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="check3">
                        <label class="form-check-label" for="check3">Risk under 2%?</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="check4">
                        <label class="form-check-label" for="check4">R:R at least 1:1?</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="check5">
                        <label class="form-check-label" for="check5">Not revenge trading?</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check6">
                        <label class="form-check-label" for="check6">Emotionally stable?</label>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <span id="checklist_score" class="badge bg-secondary fs-6">0/6 Complete</span>
                    </div>
                </div>
            </div>
            
            <!-- Tips -->
            <div class="card mb-4 border-info">
                <div class="card-body">
                    <h6 class="text-info"><i class="fas fa-lightbulb"></i> Pro Tips</h6>
                    <ul class="small mb-0">
                        <li>Always define your exit BEFORE entry</li>
                        <li>Never risk more than you can afford to lose</li>
                        <li>If in doubt, stay out</li>
                        <li>Screenshots help you review later</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="d-flex gap-3 justify-content-end mb-5">
        <a href="{{ url_for('trade.view', trade_id=trade.id) }}" class="btn btn-secondary btn-lg px-4">
            <i class="fas fa-times"></i> Cancel
        </a>
        {{ form.submit(class="btn btn-primary btn-lg px-5") }}
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Calculate R:R
function calculateRR() {
    const entry = parseFloat(document.getElementById('planned_entry').value) || 0;
    const sl = parseFloat(document.getElementById('planned_sl').value) || 0;
    const tp = parseFloat(document.getElementById('planned_tp').value) || 0;
    
    if (entry && sl && tp) {
        const risk = Math.abs(entry - sl);
        const reward = Math.abs(tp - entry);
        
        if (risk > 0) {
            const rr = (reward / risk).toFixed(2);
            document.getElementById('planned_rr').textContent = `1:${rr}`;
            document.getElementById('risk_dist').textContent = risk.toFixed(5);
            document.getElementById('reward_dist').textContent = reward.toFixed(5);
            
            const rrEl = document.getElementById('planned_rr');
            if (rr >= 2) rrEl.className = 'h4 text-success';
            else if (rr >= 1) rrEl.className = 'h4 text-warning';
            else rrEl.className = 'h4 text-danger';
        }
    }
}

['planned_entry', 'planned_sl', 'planned_tp'].forEach(id => {
    document.getElementById(id).addEventListener('input', calculateRR);
});

// Emotion warning
document.getElementById('emotion_before').addEventListener('change', function() {
    const dangerous = ['FOMO', 'Revenge Trading', 'Greedy', 'Anxious'];
    const warning = document.getElementById('emotion_warning');
    if (dangerous.includes(this.value)) {
        warning.classList.remove('d-none');
    } else {
        warning.classList.add('d-none');
    }
});

// Screenshot preview
document.getElementById('screenshot_before').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('screenshot_preview').src = e.target.result;
            document.getElementById('preview_container').classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }
});

// Checklist counter
document.querySelectorAll('[id^="check"]').forEach(cb => {
    cb.addEventListener('change', function() {
        const checked = document.querySelectorAll('[id^="check"]:checked').length;
        const badge = document.getElementById('checklist_score');
        badge.textContent = `${checked}/6 Complete`;
        
        if (checked === 6) badge.className = 'badge bg-success fs-6';
        else if (checked >= 4) badge.className = 'badge bg-warning fs-6';
        else badge.className = 'badge bg-secondary fs-6';
    });
});
</script>
{% endblock %}
