{% extends "base.html" %}

{% block title %}Add Trade - {{ app_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/instrument-picker-simple.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <form method="POST" action="{{ url_for('trade.add') }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Basic Information</h5>
                    <!-- Instrument code display (updated when user selects an instrument) -->
                    <div id="header-instrument-code" class="text-white text-opacity-75 small">No instrument selected</div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Instrument *</label>
                            <div class="instrument-picker-container">
                                <!-- Category Tabs -->
                                <div class="instrument-categories mb-2">
                                    <button type="button" class="category-tab active" data-category="forex">
                                        <i class="fas fa-exchange-alt"></i> Forex
                                    </button>
                                    <button type="button" class="category-tab" data-category="index">
                                        <i class="fas fa-chart-line"></i> Indices
                                    </button>
                                    <button type="button" class="category-tab" data-category="crypto">
                                        <i class="fas fa-bitcoin-sign"></i> Crypto
                                    </button>
                                    <button type="button" class="category-tab" data-category="commodity">
                                        <i class="fas fa-oil-can"></i> Metals
                                    </button>
                                </div>

                                <!-- Instrument List -->
                                <div class="instrument-list" id="instrument-list">
                                    <!-- Instruments will be loaded here -->
                                </div>

                                <!-- Selected Instrument Display -->
                                <div class="selected-instrument mt-2" id="selected-instrument">
                                    <small class="text-muted">No instrument selected</small>
                                </div>

                                <!-- Hidden inputs for form submission -->
                                <input type="hidden" id="instrument_id" name="instrument_id">
                                <input type="hidden" id="symbol" name="symbol">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="trade_type" class="form-label fw-bold">Trade Type *</label>
                            <select class="form-select" id="trade_type" name="trade_type" required>
                                <option value="">Select...</option>
                                <option value="BUY">BUY (Long) ðŸ“ˆ</option>
                                <option value="SELL">SELL (Short) ðŸ“‰</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="lot_size" class="form-label fw-bold">Lot Size *</label>
                            <input type="number" step="0.01" class="form-control" id="lot_size"
                                   name="lot_size" value="1.0" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Levels -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Price Levels</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="entry_price" class="form-label fw-bold">Entry Price *</label>
                            <input type="number" step="0.00001" class="form-control" id="entry_price"
                                   name="entry_price" required placeholder="1.20000">
                        </div>

                        <div class="col-md-3">
                            <label for="stop_loss" class="form-label fw-bold">Stop Loss</label>
                            <input type="number" step="0.00001" class="form-control" id="stop_loss"
                                   name="stop_loss" placeholder="1.19500">
                        </div>

                        <div class="col-md-3">
                            <label for="take_profit" class="form-label fw-bold">Take Profit</label>
                            <input type="number" step="0.00001" class="form-control" id="take_profit"
                                   name="take_profit" placeholder="1.21000">
                        </div>

                        <div class="col-md-3">
                            <label for="exit_price" class="form-label fw-bold">Exit Price (if closed)</label>
                            <input type="number" step="0.00001" class="form-control" id="exit_price"
                                   name="exit_price" placeholder="1.20500">
                        </div>
                    </div>

                    <div class="mt-3 p-3" style="background-color: #f8f9fa; border-radius: 10px;">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <small class="text-muted d-block">Risk:Reward Ratio</small>
                                <strong id="rr_display" class="h5">â€”</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Risk (pips/points)</small>
                                <strong id="risk_display" class="h5">â€”</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">Reward (pips/points)</small>
                                <strong id="reward_display" class="h5">â€”</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy & Session -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chess"></i> Strategy & Session</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="strategy" class="form-label fw-bold">Strategy</label>
                            <select class="form-select" id="strategy" name="strategy">
                                <option value="">Select strategy...</option>
                                {% for strategy in config.STRATEGIES %}
                                    <option value="{{ strategy }}">
                                        {{ strategy }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="session_type" class="form-label fw-bold">Trading Session</label>
                            <select class="form-select" id="session_type" name="session_type">
                                <option value="">Select session...</option>
                                {% for session in config.SESSION_TYPES %}
                                    <option value="{{ session }}">
                                        {{ session }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="timeframe" class="form-label fw-bold">Timeframe</label>
                            <select class="form-select" id="timeframe" name="timeframe">
                                <option value="">Select...</option>
                                <option value="1M">1 Minute</option>
                                <option value="5M">5 Minutes</option>
                                <option value="15M">15 Minutes</option>
                                <option value="30M">30 Minutes</option>
                                <option value="1H">1 Hour</option>
                                <option value="4H">4 Hours</option>
                                <option value="1D">1 Day</option>
                                <option value="1W">1 Week</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Psychology -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-brain"></i> Psychology & Quality</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="emotion" class="form-label fw-bold">Emotion</label>
                            <select class="form-select" id="emotion" name="emotion">
                                <option value="">Select emotion...</option>
                                {% for emotion in config.EMOTIONS %}
                                    <option value="{{ emotion }}">
                                        {{ emotion }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="confidence_level" class="form-label fw-bold">Confidence Level</label>
                            <select class="form-select" id="confidence_level" name="confidence_level">
                                <option value="">Select...</option>
                                {% for i in range(10, 0, -1) %}
                                    <option value="{{ i }}">
                                        {{ i }} - {% if i >= 8 %}Very Confident{% elif i >= 5 %}Neutral{% else %}Unsure{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Trade Notes</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="pre_trade_plan" class="form-label fw-bold">Pre-Trade Plan</label>
                        <textarea class="form-control" id="pre_trade_plan" name="pre_trade_plan" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="post_trade_notes" class="form-label fw-bold">Post-Trade Notes</label>
                        <textarea class="form-control" id="post_trade_notes" name="post_trade_notes" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Compliance -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Compliance</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checklist_completed"
                                       name="checklist_completed">
                                <label class="form-check-label fw-bold" for="checklist_completed">
                                    âœ… Pre-trade checklist completed
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="playbook_followed"
                                       name="playbook_followed">
                                <label class="form-check-label fw-bold" for="playbook_followed">
                                    ðŸ“– Playbook rules followed
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-flex gap-3 justify-content-end mb-5">
                <a href="{{ url_for('trade.list') }}" class="btn btn-secondary btn-lg px-5">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-save"></i> Save Trade
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/instrument-picker-simple.js') }}"></script>
<script>
// Calculate R:R ratio
function calculateRR() {
    const entry = parseFloat(document.getElementById('entry_price').value) || 0;
    const sl = parseFloat(document.getElementById('stop_loss').value) || 0;
    const tp = parseFloat(document.getElementById('take_profit').value) || 0;

    if (entry && sl && tp) {
        const risk = Math.abs(entry - sl);
        const reward = Math.abs(tp - entry);

        if (risk > 0) {
            const rr = (reward / risk).toFixed(2);
            document.getElementById('rr_display').textContent = `1:${rr}`;
            document.getElementById('risk_display').textContent = risk.toFixed(5);
            document.getElementById('reward_display').textContent = reward.toFixed(5);

            // Color code the R:R
            const rrElement = document.getElementById('rr_display');
            if (rr >= 2) {
                rrElement.style.color = '#10b981'; // Green
            } else if (rr >= 1) {
                rrElement.style.color = '#f59e0b'; // Orange
            } else {
                rrElement.style.color = '#ef4444'; // Red
            }
        }
    } else {
        document.getElementById('rr_display').textContent = 'â€”';
        document.getElementById('risk_display').textContent = 'â€”';
        document.getElementById('reward_display').textContent = 'â€”';
    }
}

// Attach listeners
['entry_price', 'stop_loss', 'take_profit'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', calculateRR);
});
</script>
{% endblock %}
