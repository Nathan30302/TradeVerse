{% extends "base.html" %}

{% block title %}Trade Details - {{ app_name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">
                {{ trade.get_result_emoji() }} {{ trade.symbol }} {{ trade.trade_type }}
            </h1>
            <p class="page-subtitle">Trade #{{ trade.id }} ‚Ä¢ {{ trade.entry_date|datetime('%B %d, %Y at %H:%M') }}</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('trade.edit', trade_id=trade.id) }}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Trade
            </a>
            <a href="{{ url_for('trade.list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i> All Trades
            </a>
        </div>
    </div>
</div>

<!-- Status Badge -->
<div class="mb-4">
    <span class="badge bg-{% if trade.status == 'OPEN' %}warning{% elif trade.status == 'CLOSED' %}secondary{% else %}info{% endif %} p-3 fs-6">
        {{ trade.status }}
    </span>
    {% if trade.profit_loss %}
        {% if trade.is_winner() %}
            <span class="badge bg-success p-3 fs-6">WINNER ‚úÖ</span>
        {% elif trade.is_loser() %}
            <span class="badge bg-danger p-3 fs-6">LOSER ‚ùå</span>
        {% else %}
            <span class="badge bg-secondary p-3 fs-6">BREAK EVEN ‚ûñ</span>
        {% endif %}
    {% endif %}
</div>

<!-- Key Metrics -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card {% if trade.profit_loss %}{% if trade.profit_loss >= 0 %}success{% else %}danger{% endif %}{% endif %}">
            <div class="stat-label">Profit/Loss</div>
            <div class="stat-value {% if trade.profit_loss %}{% if trade.profit_loss >= 0 %}profit{% else %}loss{% endif %}{% endif %}">
                {% if trade.profit_loss %}
                    {{ trade.profit_loss|currency(current_user.preferred_currency) }}
                {% else %}
                    <span class="text-muted">Open</span>
                {% endif %}
            </div>
            {% if trade.profit_loss_pips %}
                <div class="stat-change text-muted">
                    {{ trade.profit_loss_pips }} pips
                </div>
            {% endif %}
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="stat-label">Risk:Reward</div>
            <div class="stat-value">
                {% if trade.risk_reward %}
                    {{ trade.risk_reward|rr_ratio }}
                {% else %}
                    <span class="text-muted">N/A</span>
                {% endif %}
            </div>
            <div class="stat-change text-muted">
                {% if trade.risk_reward %}
                    {% if trade.risk_reward >= 2 %}
                        Excellent üéØ
                    {% elif trade.risk_reward >= 1 %}
                        Good ‚úì
                    {% else %}
                        Poor ‚ö†Ô∏è
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card info">
            <div class="stat-label">Duration</div>
            <div class="stat-value">{{ trade.get_duration() }}</div>
            <div class="stat-change text-muted">
                {% if trade.exit_date %}
                    Closed {{ trade.exit_date|datetime('%m/%d/%y') }}
                {% else %}
                    Still open
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Lot Size</div>
            <div class="stat-value">{{ trade.lot_size }}</div>
            <div class="stat-change text-muted">Position size</div>
        </div>
    </div>
</div>

<!-- Trade Details -->
<div class="row">
    <div class="col-md-8">
        <!-- Price Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Price Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="text-muted small">Entry Price</label>
                            <div class="h4">{{ "%.5f"|format(trade.entry_price) }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Stop Loss</label>
                            <div class="h4">
                                {% if trade.stop_loss %}
                                    {{ "%.5f"|format(trade.stop_loss) }}
                                {% else %}
                                    <span class="text-muted">Not set ‚ö†Ô∏è</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="text-muted small">Exit Price</label>
                            <div class="h4">
                                {% if trade.exit_price %}
                                    {{ "%.5f"|format(trade.exit_price) }}
                                {% else %}
                                    <span class="text-muted">Open</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Take Profit</label>
                            <div class="h4">
                                {% if trade.take_profit %}
                                    {{ "%.5f"|format(trade.take_profit) }}
                                {% else %}
                                    <span class="text-muted">Not set</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy & Psychology -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain"></i> Strategy & Psychology</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Strategy</label>
                        <div>
                            {% if trade.strategy %}
                                <span class="badge bg-info fs-6 p-2">{{ trade.strategy }}</span>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Emotion</label>
                        <div>
                            {% if trade.emotion %}
                                <span class="badge 
                                    {% if trade.emotion in ['FOMO', 'Revenge Trading', 'Greedy'] %}bg-danger
                                    {% elif trade.emotion in ['Confident', 'Calm & Focused'] %}bg-success
                                    {% else %}bg-secondary{% endif %} fs-6 p-2">
                                    {{ trade.emotion }}
                                </span>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Session</label>
                        <div>
                            {% if trade.session_type %}
                                <span class="badge bg-primary fs-6 p-2">{{ trade.session_type }}</span>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Timeframe</label>
                        <div>
                            {% if trade.timeframe %}
                                <span class="badge bg-secondary fs-6 p-2">{{ trade.timeframe }}</span>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if trade.confidence_level %}
                    <div class="col-md-6 mb-3">
                        <label class="text-muted small">Confidence Level</label>
                        <div>
                            <span class="badge bg-{% if trade.confidence_level >= 7 %}success{% elif trade.confidence_level >= 4 %}warning{% else %}danger{% endif %} fs-6 p-2">
                                {{ trade.confidence_level }}/10
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notes -->
        {% if trade.pre_trade_plan or trade.post_trade_notes %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Trade Notes</h5>
            </div>
            <div class="card-body">
                {% if trade.pre_trade_plan %}
                    <div class="mb-3">
                        <h6 class="fw-bold">Pre-Trade Plan</h6>
                        <p class="mb-0" style="white-space: pre-wrap;">{{ trade.pre_trade_plan }}</p>
                    </div>
                {% endif %}
                {% if trade.post_trade_notes %}
                    <div>
                        <h6 class="fw-bold">Post-Trade Notes</h6>
                        <p class="mb-0" style="white-space: pre-wrap;">{{ trade.post_trade_notes }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <!-- Compliance -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Compliance</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {% if trade.checklist_completed %}
                        <div class="alert alert-success mb-2">
                            <i class="fas fa-check-circle"></i> Checklist completed
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle"></i> Checklist not completed
                        </div>
                    {% endif %}
                </div>
                <div>
                    {% if trade.playbook_followed %}
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle"></i> Playbook followed
                        </div>
                    {% else %}
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-times-circle"></i> Playbook not followed
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AI Feedback -->
        <div class="card mb-4">
            <div class="card-header bg-primary">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> AI Feedback</h5>
                    <form action="{{ url_for('trade.generate_feedback', trade_id=trade.id) }}" method="POST" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-light">
                            <i class="fas fa-sync-alt"></i> Analyze
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                {% if feedbacks %}
                    <div class="ai-suggestions">
                    {% for feedback in feedbacks %}
                        <div class="ai-suggestion alert {% if feedback.feedback_type == 'positive' %}alert-success{% elif feedback.feedback_type == 'warning' %}alert-warning{% else %}alert-danger{% endif %} py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="meta">{{ feedback.category|capitalize }}</div>
                                    <div><span class="me-1">{{ feedback.icon }}</span> {{ feedback.message }}</div>
                                </div>
                                {% if feedback.impact_score != 0 %}
                                <div>
                                    <span class="badge {% if feedback.impact_score > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if feedback.impact_score > 0 %}+{% endif %}{{ feedback.impact_score }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-2">No feedback yet.</p>
                    <p class="text-center mb-0">
                        <small>Click "Analyze" to generate AI feedback for this trade.</small>
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Mistakes Detected -->
        {% if mistakes %}
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Mistakes Detected</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for mistake in mistakes %}
                        <li class="mb-2">
                            <i class="fas fa-arrow-right text-warning"></i> {{ mistake }}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h6>No Mistakes Detected!</h6>
                <p class="text-muted small mb-0">Great job following your rules!</p>
            </div>
        </div>
        {% endif %}

        <!-- Trade Plan -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Trade Plan</h5>
            </div>
            <div class="card-body">
                {% set trade_plan = trade.plan[0] if trade.plan and trade.plan|length > 0 else trade.plan if trade.plan and not trade.plan is iterable else none %}
                {% if trade_plan %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Plan Quality</span>
                            <span class="badge {% if trade_plan.plan_quality_score and trade_plan.plan_quality_score >= 80 %}bg-success{% elif trade_plan.plan_quality_score and trade_plan.plan_quality_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ trade_plan.plan_quality_score or 0 }}/100
                            </span>
                        </div>
                        {% if trade_plan.is_complete() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Execution Quality</span>
                            <span class="badge {% if trade_plan.execution_quality_score and trade_plan.execution_quality_score >= 80 %}bg-success{% elif trade_plan.execution_quality_score and trade_plan.execution_quality_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ trade_plan.execution_quality_score or 0 }}/100
                            </span>
                        </div>
                        <div class="alert alert-success py-2 mb-0">
                            <i class="fas fa-check-circle"></i> Review completed
                        </div>
                        {% else %}
                        <div class="alert alert-warning py-2 mb-0">
                            <i class="fas fa-clock"></i> Pending review
                        </div>
                        {% endif %}
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('planner.view_plan', trade_id=trade.id) }}" class="btn btn-info">
                            <i class="fas fa-eye"></i> View Plan
                        </a>
                        {% if not trade_plan.is_complete() %}
                        <a href="{{ url_for('planner.review_trade', trade_id=trade.id) }}" class="btn btn-success">
                            <i class="fas fa-clipboard-check"></i> Complete Review
                        </a>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted mb-3">No trade plan yet. Planning helps improve discipline!</p>
                    <div class="d-grid">
                        <a href="{{ url_for('planner.create_plan', trade_id=trade.id) }}" class="btn btn-info">
                            <i class="fas fa-plus"></i> Create Trade Plan
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('trade.edit', trade_id=trade.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Trade
                    </a>
                    {% if trade.status == 'OPEN' %}
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#closeModal">
                        <i class="fas fa-check"></i> Close Trade
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete Trade
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Close Trade Modal -->
{% if trade.status == 'OPEN' %}
<div class="modal fade" id="closeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Close Trade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('trade.close', trade_id=trade.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Exit Price *</label>
                        <input type="number" step="0.00001" class="form-control" name="exit_price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Exit Date/Time</label>
                        <input type="datetime-local" class="form-control" name="exit_date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Close Trade</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this trade?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    This action cannot be undone!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('trade.delete', trade_id=trade.id) }}" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}